<!DOCTYPE html>
<html>
<head>
    <title>Test de Pr√©stamos - Firebase Debug</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .test-button:hover { background: #0056b3; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        #output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-top: 20px;
            max-height: 500px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background-color: #28a745; }
        .status-error { background-color: #dc3545; }
        .status-warning { background-color: #ffc107; }
        .status-info { background-color: #17a2b8; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test de Pr√©stamos - Debug Firebase</h1>
        <p>Esta p√°gina te ayudar√° a diagnosticar si los pr√©stamos se pueden crear correctamente en Firebase.</p>
        
        <div>
            <h3>üîß Tests Disponibles</h3>
            <button class="test-button" onclick="testFirebaseConnection()">
                üîó Test Conexi√≥n Firebase
            </button>
            <button class="test-button" onclick="testCrearPrestamo()">
                üíæ Test Crear Pr√©stamo
            </button>
            <button class="test-button" onclick="testConsultaPorActividad()">
                üîç Test Consulta por Actividad
            </button>
            <button class="test-button" onclick="testCrearActividadCompleta()">
                üéØ Test Actividad + Pr√©stamos
            </button>
            <button class="test-button" onclick="clearOutput()">
                üóëÔ∏è Limpiar Log
            </button>
        </div>

        <div id="output"></div>
    </div>

    <script>
        // Funci√≥n para logging con colores
        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString();
            const icons = {
                info: 'üîµ',
                success: '‚úÖ', 
                error: '‚ùå',
                warning: '‚ö†Ô∏è'
            };
            
            const line = `[${timestamp}] ${icons[type]} ${message}\n`;
            output.innerHTML += line;
            output.scrollTop = output.scrollHeight;
            console.log(message);
        }

        function clearOutput() {
            document.getElementById('output').innerHTML = '';
        }

        // Test 1: Verificar conexi√≥n a Firebase
        async function testFirebaseConnection() {
            log('üöÄ Iniciando test de conexi√≥n Firebase...', 'info');
            
            try {
                // Verificar si Firebase est√° disponible
                if (typeof window.firebase === 'undefined') {
                    log('‚ùå Firebase SDK no est√° disponible en window.firebase', 'error');
                    return false;
                }

                // Intentar acceder a Firestore
                const db = window.firebase.firestore();
                if (!db) {
                    log('‚ùå No se pudo acceder a Firestore', 'error');
                    return false;
                }

                log('‚úÖ Firebase est√° disponible', 'success');
                log(`üìå Proyecto: ${window.firebase.app().options.projectId}`, 'info');
                
                // Test b√°sico de lectura
                const testCollection = db.collection('usuarios').limit(1);
                const snapshot = await testCollection.get();
                log(`üîç Test lectura usuarios: ${snapshot.size} documentos`, 'success');
                
                return true;
                
            } catch (error) {
                log(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
                log(`üîç C√≥digo: ${error.code || 'N/A'}`, 'warning');
                return false;
            }
        }

        // Test 2: Crear pr√©stamo de prueba
        async function testCrearPrestamo() {
            log('üíæ Iniciando test de creaci√≥n de pr√©stamo...', 'info');
            
            try {
                const db = window.firebase.firestore();
                
                // Datos del pr√©stamo de prueba
                const prestamoData = {
                    materialId: 'TEST_' + Date.now(),
                    nombreMaterial: 'Material Test Debug',
                    usuarioId: 'USER_TEST_' + Date.now(),
                    nombreUsuario: 'Usuario Test Debug',
                    cantidadPrestada: 1,
                    fechaPrestamo: window.firebase.firestore.Timestamp.now(),
                    fechaDevolucionPrevista: window.firebase.firestore.Timestamp.fromDate(
                        new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)
                    ),
                    estado: 'en_uso',
                    actividadId: 'ACT_TEST_' + Date.now(),
                    nombreActividad: 'Actividad Test Debug',
                    observaciones: 'Creado por test debug - ' + new Date().toISOString()
                };

                log('üìù Datos del pr√©stamo:', 'info');
                log(JSON.stringify(prestamoData, null, 2), 'info');

                // Crear el pr√©stamo
                const docRef = await db.collection('prestamos').add(prestamoData);
                log(`‚úÖ ¬°Pr√©stamo creado exitosamente! ID: ${docRef.id}`, 'success');

                // Verificar que se cre√≥
                const doc = await docRef.get();
                if (doc.exists) {
                    log('‚úÖ Verificaci√≥n exitosa - Pr√©stamo encontrado en BD', 'success');
                    return { success: true, id: docRef.id };
                } else {
                    log('‚ùå Error: Pr√©stamo no encontrado despu√©s de crear', 'error');
                    return { success: false };
                }

            } catch (error) {
                log(`‚ùå Error al crear pr√©stamo: ${error.message}`, 'error');
                log(`üîç C√≥digo: ${error.code || 'N/A'}`, 'warning');
                
                if (error.code === 'permission-denied') {
                    log('üí° Soluci√≥n: Verifica las reglas de Firestore y autenticaci√≥n', 'warning');
                } else if (error.code === 'failed-precondition') {
                    log('üí° Soluci√≥n: Puede faltar un √≠ndice de Firebase', 'warning');
                }
                
                return { success: false, error: error.message };
            }
        }

        // Test 3: Consulta por actividad (la que falla)
        async function testConsultaPorActividad() {
            log('üîç Iniciando test de consulta por actividad...', 'info');
            
            try {
                const db = window.firebase.firestore();
                
                // Crear un pr√©stamo primero
                const testActivityId = 'TEST_ACTIVITY_' + Date.now();
                const prestamoData = {
                    materialId: 'MAT_' + Date.now(),
                    nombreMaterial: 'Material para consulta',
                    usuarioId: 'USER_' + Date.now(), 
                    nombreUsuario: 'Usuario consulta',
                    cantidadPrestada: 1,
                    fechaPrestamo: window.firebase.firestore.Timestamp.now(),
                    fechaDevolucionPrevista: window.firebase.firestore.Timestamp.fromDate(
                        new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)
                    ),
                    estado: 'en_uso',
                    actividadId: testActivityId,
                    nombreActividad: 'Actividad para consulta'
                };

                log('üìù Creando pr√©stamo para test de consulta...', 'info');
                const docRef = await db.collection('prestamos').add(prestamoData);
                log(`‚úÖ Pr√©stamo creado: ${docRef.id}`, 'success');

                // Ahora probar la consulta que usa la app
                log('üîç Probando consulta por actividad...', 'info');
                
                const query = db.collection('prestamos')
                    .where('actividadId', '==', testActivityId)
                    .orderBy('fechaPrestamo', 'desc');

                const snapshot = await query.get();
                log(`üìä Resultados encontrados: ${snapshot.size}`, 'success');

                if (snapshot.size > 0) {
                    log('‚úÖ ¬°Consulta exitosa! La consulta por actividad funciona', 'success');
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        log(`  - ${doc.id}: ${data.nombreMaterial}`, 'info');
                    });
                    return { success: true, results: snapshot.size };
                } else {
                    log('‚ö†Ô∏è Consulta ejecutada pero no se encontraron resultados', 'warning');
                    return { success: true, results: 0 };
                }

            } catch (error) {
                log(`‚ùå Error en consulta: ${error.message}`, 'error');
                log(`üîç C√≥digo: ${error.code || 'N/A'}`, 'warning');
                
                if (error.code === 'failed-precondition') {
                    log('üí° PROBLEMA ENCONTRADO: Falta √≠ndice en Firebase', 'warning');
                    log('üí° Soluci√≥n: Crear √≠ndice para campos: actividadId + fechaPrestamo', 'warning');
                    
                    // Buscar enlace de creaci√≥n de √≠ndice en el mensaje de error
                    const indexLink = error.message.match(/https:\/\/[^\s]+/);
                    if (indexLink) {
                        log(`üîó Enlace para crear √≠ndice: ${indexLink[0]}`, 'info');
                    }
                }
                
                return { success: false, error: error.message };
            }
        }

        // Test 4: Flujo completo como en la app
        async function testCrearActividadCompleta() {
            log('üéØ Iniciando test de flujo completo: Actividad + Pr√©stamos...', 'info');
            
            try {
                // Simular el flujo completo de la aplicaci√≥n
                log('1Ô∏è‚É£ Simulando creaci√≥n de actividad...', 'info');
                
                const actividadData = {
                    nombre: 'Actividad Test Completa ' + Date.now(),
                    descripcion: 'Test del flujo completo de creaci√≥n',
                    fechaInicio: new Date(),
                    fechaFin: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),
                    necesidadMaterial: true,
                    responsableMaterialId: 'USER_RESP_' + Date.now(),
                    materiales: [
                        {
                            materialId: 'MAT_1_' + Date.now(),
                            nombre: 'Material Test 1',
                            cantidad: 2
                        },
                        {
                            materialId: 'MAT_2_' + Date.now(),
                            nombre: 'Material Test 2', 
                            cantidad: 1
                        }
                    ],
                    estado: 'planificada'
                };

                log('üìù Datos de actividad:', 'info');
                log(JSON.stringify(actividadData, null, 2), 'info');

                // Crear actividad (simulando guardarActividad())
                const db = window.firebase.firestore();
                const actividadRef = await db.collection('actividades').add(actividadData);
                log(`‚úÖ Actividad creada: ${actividadRef.id}`, 'success');

                // Simular crearPrestamosParaActividad()
                log('2Ô∏è‚É£ Creando pr√©stamos para la actividad...', 'info');
                
                const prestamosCreados = [];
                
                for (const material of actividadData.materiales) {
                    const prestamoData = {
                        materialId: material.materialId,
                        nombreMaterial: material.nombre,
                        cantidadPrestada: material.cantidad,
                        usuarioId: actividadData.responsableMaterialId,
                        nombreUsuario: 'Usuario Responsable Test',
                        actividadId: actividadRef.id,
                        nombreActividad: actividadData.nombre,
                        fechaPrestamo: window.firebase.firestore.Timestamp.now(),
                        fechaDevolucionPrevista: window.firebase.firestore.Timestamp.fromDate(actividadData.fechaFin),
                        estado: 'en_uso',
                        observaciones: 'Creado autom√°ticamente por test completo'
                    };

                    const prestamoRef = await db.collection('prestamos').add(prestamoData);
                    prestamosCreados.push(prestamoRef.id);
                    log(`‚úÖ Pr√©stamo creado: ${prestamoRef.id} (${material.nombre})`, 'success');
                }

                // Verificar que los pr√©stamos se pueden consultar
                log('3Ô∏è‚É£ Verificando consulta de pr√©stamos por actividad...', 'info');
                
                try {
                    const prestamosQuery = db.collection('prestamos')
                        .where('actividadId', '==', actividadRef.id)
                        .orderBy('fechaPrestamo', 'desc');

                    const prestamosSnapshot = await prestamosQuery.get();
                    log(`üìä Pr√©stamos encontrados en consulta: ${prestamosSnapshot.size}`, 'success');

                    if (prestamosSnapshot.size === prestamosCreados.length) {
                        log('‚úÖ ¬°√âXITO TOTAL! El flujo completo funciona correctamente', 'success');
                        log(`‚úÖ Actividad: ${actividadRef.id}`, 'success');
                        log(`‚úÖ Pr√©stamos: ${prestamosCreados.join(', ')}`, 'success');
                        return { 
                            success: true, 
                            actividadId: actividadRef.id, 
                            prestamosIds: prestamosCreados 
                        };
                    } else {
                        log(`‚ö†Ô∏è Discrepancia: creados ${prestamosCreados.length}, encontrados ${prestamosSnapshot.size}`, 'warning');
                        return { success: false, error: 'Discrepancia en cantidad de pr√©stamos' };
                    }

                } catch (queryError) {
                    log(`‚ùå Error en consulta final: ${queryError.message}`, 'error');
                    log('üí° Los pr√©stamos se crearon pero no se pueden consultar (problema de √≠ndice)', 'warning');
                    return { 
                        success: false, 
                        error: 'Pr√©stamos creados pero consulta falla',
                        prestamosCreados: prestamosCreados.length
                    };
                }

            } catch (error) {
                log(`‚ùå Error en flujo completo: ${error.message}`, 'error');
                log(`üîç C√≥digo: ${error.code || 'N/A'}`, 'warning');
                return { success: false, error: error.message };
            }
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            log('üéâ Test de Pr√©stamos cargado correctamente', 'success');
            log('üí° Ejecuta los tests uno por uno para diagnosticar el problema', 'info');
            log('üìã Orden recomendado: Conexi√≥n ‚Üí Crear Pr√©stamo ‚Üí Consulta ‚Üí Flujo Completo', 'info');
        });
    </script>
</body>
</html>
